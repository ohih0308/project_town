<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ohih.town.domain.post.mapper.PostMapper">
    <!--  Long getUserIdByPostId(Long postId);  -->
    <select id="getUserIdByPostId" parameterType="Long" resultType="Long">
        select user_id
        from posts
        where post_id = #{postId};
    </select>

    <!--  AccessInfo getAccessInfo(Long postId);  -->
    <select id="getAccessInfo" parameterType="Long" resultType="AccessInfo">
        select post_id   as postId,
               user_id   as userId,
               user_type as userType,
               password
        from posts
        where post_id = #{postId};
    </select>

<!--  List<Attachment> getAttachments(Long postId);  -->
    <select id="getAttachments" parameterType="Long" resultType="Attachment">
        select *
        from attachments
        where post_id = #{postId};
    </select>

    <!--  boolean uploadPost(PostUploadRequest postUploadRequest);  -->
    <insert id="uploadPost" parameterType="PostUploadRequest" useGeneratedKeys="true" keyProperty="postId">
        insert into posts (board_id, user_type, ip, author, password, subject, body, views, created_at, updated_at)
        values (#{boardId}, #{userType}, #{ip}, #{author}, #{password}, #{subject}, #{body}, 0, now(), now());
    </insert>

    <!--  boolean uploadAttachment(Attachment attachment);  -->
    <insert id="uploadAttachment" parameterType="Attachment">
        insert into attachments (file_name, extension, post_id, directory)
        values (#{fileName}, #{extension}, #{postId}, #{directory});
    </insert>

    <!--  boolean uploadThumbnail(Attachment attachment);  -->
    <insert id="uploadThumbnail" parameterType="Attachment">
        insert into thumbnails (post_id, file_name, directory)
        values (#{postId}, #{fileName}, #{directory});
    </insert>

<!--  boolean updateThumbnail(Attachment attachment);  -->
    <update id="updateThumbnail" parameterType="Attachment">
        update thumbnails
        set file_name = #{fileNmae},
            directory = #{directory}
        where post_id = #{postId};
    </update>

    <!--  boolean updateAttachment(Attachment attachment);  -->
    <update id="updateAttachment" parameterType="Attachment">
        update attachments
        set file_name = #{fileName},
            extension = #{extension},
            directory = #{directory}
        where post_id = #{postId}
    </update>


    <!--  boolean updatePost(PostUploadRequest postUploadRequest);  -->
    <update id="updatePost" parameterType="PostUploadRequest">
        update posts
        set board_id   = #{boardId},
            user_id    = #{userId},
            user_type  = #{userType},
            ip         = #{ip},
            author     = #{author},
            password   = #{password},
            subject    = #{subject},
            body       = #{body},
            updated_at = NOW()
    </update>

</mapper>